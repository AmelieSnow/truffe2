{% extends "generic/generic/edit.html" %}

{% block line_add_line_bonus %}
    new_line.find('.line_field_lines_value input').on('change', handle_tva_ht);
    new_line.find('.line_field_lines_value_ttc input').on('change', handle_tva_ttc);
    new_line.find('.line_field_lines_tva input').on('change', handle_tva_tva);
{% endblock %}

{% block bonus_unit_updated %}
    update_users(pk);
{% endblock %}

{% block line_js_bonus %}

    function handle_tva_ht(obj) {

        var tva = $(obj.target).parents('tr').find('.line_field_lines_tva input').select2('val');
        if (tva < 0)
            tva = 0;
        var ht = $(obj.target).val();
        var tt = ht * (1.0 + tva / 100.0);

        tt = (Math.round(tt * 20) / 20).toFixed(2);

        $(obj.target).parents('tr').find('.line_field_lines_value_ttc input').val(tt).pulse();

    }

    function handle_tva_ttc(obj) {

        var tva = $(obj.target).parents('tr').find('.line_field_lines_tva input').select2('val');
        if (tva < 0)
            tva = 0;
        var ttc = $(obj.target).val();
        var ht = ttc / (1.0 + tva / 100.0);

        ht = ht.toFixed(2);

        $(obj.target).parents('tr').find('.line_field_lines_value input').val(ht).pulse();
    }

    function handle_tva_tva(obj) {

        var ttc = $(obj.target).parents('tr').find('.line_field_lines_value_ttc input').val();
        var tva = $(obj.target).parents('tr').find('.line_field_lines_tva input').select2('val');

        if (tva < 0)
            tva = 0;

        if (ttc == 0 || ttc == "") {

            var ht = $(obj.target).parents('tr').find('.line_field_lines_value input').val();
            var tt = ht * (1.0 + tva / 100.0);

            tt = (Math.round(tt * 20) / 20).toFixed(2);

            $(obj.target).parents('tr').find('.line_field_lines_value_ttc input').val(tt).pulse();

        } else {
            var ht = ttc / (1.0 + tva / 100.0);
            ht = ht.toFixed(2);
            $(obj.target).parents('tr').find('.line_field_lines_value input').val(ht).pulse();
        }

    }

    $(function () {
        $('.line_field_lines_value input').on('change', handle_tva_ht);
        $('.line_field_lines_value_ttc input').on('change', handle_tva_ttc);
        $('.line_field_lines_tva input').on('change', handle_tva_tva);

        // Move costcenter up
        var costcenter = $('#id_costcenter').parents('.form-group').remove();
        $('#id_name').parents('.form-group').after(costcenter);

        // Transform id_user in select2
        $('#id_user').removeClass('form-control');
        $('#id_user').width('72%').select2();

        update_users({{CURRENT_UNIT_PK}});
    });

    function update_users(pk) {
        $.ajax('{% url 'accounting_core.views.users_available_list_by_unit' 99942999 %}'.replace(99942999, pk)).done(function (data) {

            var old_value = $('#id_user').val();
            var options = '<option value=""></option>';

            $.each(data, function (index, option) {
                options += '<option value="' + option.pk + '">' + escape_html(option.name) + '</option>';
            });

            $('#id_user').select2('destroy');
            $('#id_user').html(options);
            $('#id_user').val(old_value);
            $('#id_user').select2();
        });
    }
{% endblock %}
