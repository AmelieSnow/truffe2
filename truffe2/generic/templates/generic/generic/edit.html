{% extends "base.html" %}
{% load i18n l10n bootstrap3 jfutags %}

{% block title %}{{block.super}} :: {{Model.MetaData.base_title}} :: {% if form.instance.pk %}{% trans "Edition" %}{% else %}{% trans "Création" %}{% endif %}{% endblock %}

{% block ribbon %}
    {{block.super}}
    <li><a href="{% if related_mode %}{% url list_related_view %}{% else %}{% url list_view %}{% endif %}"><i class="{{Model.MetaData.base_icon}}"></i> {{Model.MetaData.base_title}}</a></li>
    {% if form.instance.pk %}
        <li><a href="{% url show_view form.instance.pk %}{% if related_mode %}?_upkns=_&_fromrelated=_{% endif %}"><i class="{{Model.MetaData.elem_icon}}"></i> {{form.instance}}</a></li>
        <li><i class="fa fa-pencil"></i> {% trans "Edition" %}</li>
    {% else %}
        <li><i class="fa fa-plus"></i> {% trans "Création" %}</li>
    {% endif %}

  {% endblock %}


{% block content %}

    {% if form.instance.pk %}
        <h1>{{form.instance}}</h1>
    {% else %}
        <h1>{% trans "Création d'un élément" %}</h1>
    {% endif %}
  <div class="row">
    <div class="col-sm-12 col-md-12 col-lg-7">
      <div class="well">
          <form class="form-horizontal" method="POST" enctype="multipart/form-data" id="generic_main_form">
            {% csrf_token %}

            {% localize off %}
                {% bootstrap_form form layout='horizontal' %}
            {% endlocalize %}

            <input type="hidden" name="post-save-dest" id="post-save-dest" value="">
            <input type="hidden" name="file_key" value="{{file_key}}">

            {% if unit_mode %}
                <input type="hidden" id="input_upk" name="upk" value="{{form.instance.unit.pk}}">
            {% endif %}
            {% if year_mode %}
                <input type="hidden" id="input_ypk" name="ypk" value="{{form.instance.accounting_year.pk}}">
            {% endif %}
        </form>

        {% if file_mode %}
            <h3>{{Model.MetaEdit.files_title}}</h3>

            <p>{{Model.MetaEdit.files_help}}<br />{% trans "Tu peux 'drag & dropper' des fichiers sur toute la page pour les envoyer." %}</p>

            {% jfu 'generic/generic/file_upload.html' file_upload_view %}

        {% endif %}

        <div class="form-actions">
            <div class="row">
                <div class="col-md-12">
                    <a href="{% if form.instance.pk %}{% url show_view form.instance.pk %}{% else %}{% url list_view %}{% endif %}" class="btn btn-default">{% trans "Annuler" %}</a>
                    <button type="button" class="btn btn-primary" id="save_and_new" onclick="$('#post-save-dest').val('new'); $('#generic_main_form').submit();"><i class="glyphicon glyphicon-floppy-disk"></i> {% trans "Sauvegarder et créer un nouveau" %}</button>
                    <button type="button" class="btn btn-primary" id="save_and_edit" onclick="$('#post-save-dest').val('continue'); $('#generic_main_form').submit();"><i class="glyphicon glyphicon-floppy-disk"></i> {% trans "Sauvegarder et continuer l'édition" %}</button>
                    <button type="button" class="btn btn-primary" id="save" onclick="$('#generic_main_form').submit();"><i class="glyphicon glyphicon-floppy-disk"></i> {% trans "Sauvegarder" %}</button>
                </div>
            </div>
        </div>
      </div>
    </div>

    {% if unit_mode or year_mode %}

        <div class="col-sm-12 col-md-2 col-lg-2">

            {% if unit_mode %}
              {% if form.instance.pk %}
                {% with w_title="Contexte" %}{% include "widget/header.html" %}{% endwith %}
                    {% trans "Cet objet est lié à l'unité" %}<br /><br />
                    <center><b class="cgroupe" pk="{{CURRENT_UNIT_PK}}">{{CURRENT_UNIT_NAME}}</b></center><br />
                {% include "widget/footer.html" %}

              {% else %}
                  {% with function_to_call="unit_updated" %}
                      {% include "units/selector/unit_selector.html" %}
                  {% endwith %}

                  <script type="text/javascript">
                      function unit_updated(pk, name, can_edit) {
                        $('#input_upk').val(pk);
                      }
                  </script>
              {% endif %}
            {% endif %}

            {% if year_mode %}
              {% if form.instance.pk %}
                {% with w_title="Contexte" %}{% include "widget/header.html" %}{% endwith %}
                    {% trans "Cet objet est lié à l'année comptable" %}<br /><br />
                    <center><b class="cyear" pk="{{CURRENT_YEAR.pk}}">{{CURRENT_YEAR.name}}</b></center><br />
                {% include "widget/footer.html" %}

              {% else %}
                  {% with function_to_call="year_updated" %}
                      {% include "accounting_core/selector/year_selector.html" %}
                  {% endwith %}

                  <script type="text/javascript">
                      function year_updated(pk, name) {
                        $('#input_ypk').val(pk);
                      }
                  </script>
              {% endif %}
            {% endif %}

        </div>

        <script type="text/javascript">
            {% if CURRENT_UNIT_PK != -1 %}
                $('#id_unit_blank_name').parent().parent().hide();
            {% endif %}
        </script>

    {% endif %}
</div>

<script type="text/javascript" src="{{MEDIA_URL}}js/plugin/bootstrap-datetimepicker-master/js/bootstrap-datetimepicker.js"></script>
<link rel="stylesheet" type="text/css" media="screen" href="{{MEDIA_URL}}js/plugin/bootstrap-datetimepicker-master/css/bootstrap-datetimepicker.min.css">
<script type="text/javascript" src="{{MEDIA_URL}}js/plugin/summernote/summernote.js"></script>

<script type="text/javascript">


    {% for field in Model.MetaEdit.datetime_fields %}
        $("#id_{{field}}").datetimepicker({format: 'yyyy-mm-dd hh:ii', weekStart: 1, autoclose: true, todayBtn: true});
    {% endfor %}

    {% for field in Model.MetaEdit.html_fields %}
        $("#id_{{field}}").summernote({
            height : 180,
            focus : false,
            tabsize : 2,
            onblur: function (e) {
              $('#id_{{field}}').val($("#id_{{field}}").code());
            }
        });

        $("#id_{{field}}").code(($('#id_{{field}}').val()));


    {% endfor %}

    var ubn = $('#id_unit_blank_name').parent().parent();
    var ubn_parent = ubn.parent();
    ubn_parent.prepend(ubn.remove());

    $('#id_unit_blank_name').parent().append("<div class='alert alert-danger' style='margin-top: 4px; margin-bottom: 0px; display: none;' id='id_unit_blank_name_warning'>{% trans "Attention ! Une unité existe déjà avec ce nom. Est-ce que tu manques de droits pour utiliser directement l'unité ? Hors cas exceptionnels, il ne faut pas passer via une entité externe, mais demander les droits ! Demande au président !" %}</div>");

    $('#id_unit_blank_name').on('change', function (elem) {
      $.ajax('{% url 'generic.views.check_unit_name' %}?name=' + escape($('#id_unit_blank_name').val()), {dataType: 'json'}).success(function (data) {
        if (data['result'] == 'ok') {
            $('#id_unit_blank_name_warning').hide();
        } else {
            $('#id_unit_blank_name_warning').show();
        }
        });
    });

</script>

{% block edit_bonus %}

{% endblock %}

{% endblock %}


{% block menuid %}{% if related_mode %}{{Model.MetaData.menu_id_related}}{% else %}{{Model.MetaData.menu_id}}{% endif %}{% endblock %}
